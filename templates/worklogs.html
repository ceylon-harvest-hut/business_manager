{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Work Logs</h2>

    <form method="POST" class="mb-4">
        <div class="row">
            <div class="col-md-3">
                <label>Start Date</label>
                <input type="date" name="start_date" class="form-control" 
                   value="{{ current_date }}" required>
            </div>
            <div class="col-md-3">
                <label>End Date</label>
                <input type="date" name="end_date" class="form-control" 
                   value="{{ current_date }}" required>
            </div>
            <div class="form-group">
              <label for="relationship_id">Employee</label>
              <select id="relationship_id" name="relationship_id" class="form-control" required>
                <option value="">-- Select Employee --</option>
                {% for emp in employees %}
                  <option value="{{ emp.id }}">{{ emp.entity.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
                <label>Work Type</label>
                <select name="work_type_id" id="work_type_id" class="form-control" required>
                    {% for wt in work_types %}
                        <option value="{{ wt.id }}" data-rate="{{ wt.rate }}">{{ wt.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label>Work Units</label>
                <input type="number" step="0.01" name="work_units" id="work_units" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" class="form-control"></textarea>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-3">
                <label>Due Payment</label>
                <input type="text" id="due_payment" class="form-control" readonly>
            </div>
        </div>

        <div class="mb-2">
            <label>
                <input type="checkbox" name="paid" value="1">
                Mark as Paid
            </label>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Add Work Log</button>
    </form>

    <h3>Existing Work Logs</h3>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Work Type</th>
                <th>Units</th>
                <th>Due Payment</th>
            </tr>
        </thead>
        <tbody>
            {% for wl in logs %}
            <tr>
                <td>{{ wl.id }}</td>
                <td>{{ wl.start_date }}</td>
                <td>{{ wl.end_date }}</td>
                <td>{{ wl.work_type.name }}</td>
                <td>{{ wl.work_units }}</td>
                <td>{{ wl.due_payment }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function validateDates() {
    let start = document.getElementById("start_date").value;
    let end = document.getElementById("end_date").value;

    if (!start || !end) {
        alert("Both Start Date and End Date are required.");
        return false;
    }

    if (new Date(end) < new Date(start)) {
        alert("End Date cannot be earlier than Start Date.");
        return false;
    }
    return true;
}

// Auto-calc Due Payment
document.getElementById("work_units").addEventListener("input", calcDue);
document.getElementById("work_type_id").addEventListener("change", calcDue);

function calcDue() {
    let units = parseFloat(document.getElementById("work_units").value) || 0;
    let rates = {
        {% for wt in work_types %}
        "{{ wt.id }}": {{ wt.rate }},
        {% endfor %}
    };
    let selected = document.getElementById("work_type_id").value;
    let due = units * (rates[selected] || 0);
    document.getElementById("due_payment").value = due.toFixed(2);
}
</script>

{% endblock %}

